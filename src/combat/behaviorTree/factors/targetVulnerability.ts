/**
 * TargetVulnerability factor — Offensive opportunity scoring (target-aware).
 *
 * Evaluates how vulnerable the current target is based on its stamina percentage.
 * A near-KO target is a high-value opportunity to press and finish them off.
 *
 * This is one of two target-aware factors (the other is SpeedAdvantage).
 * When target is null (e.g. EVADE candidate), returns neutral scores.
 *
 * Bracket table (from design spec):
 *   target.staminaPct < 0.25  : { ATTACK: 0.8, DEFEND: -0.2, EVADE: -0.3, SPECIAL: 0.6, GROUP: 0 }
 *   target.staminaPct 0.25-0.5: { ATTACK: 0.4, DEFEND:  0.0, EVADE: -0.1, SPECIAL: 0.3, GROUP: 0 }
 *   target.staminaPct > 0.5   : { ATTACK: 0.1, DEFEND:  0.0, EVADE:  0.0, SPECIAL: 0.1, GROUP: 0 }
 *
 * Note: The design spec gives a single representative value per bracket (no "scales
 * linearly" language). This factor intentionally uses flat bracket values — no
 * interpolation within brackets.
 */

import type { ActionScores, ScoringFactor, CombatPerception, TargetPerception } from '../../../types/combat.js';

const CRITICAL_SCORES: ActionScores = { ATTACK: 0.8, DEFEND: -0.2, EVADE: -0.3, SPECIAL: 0.6, GROUP: 0 };
const MID_SCORES: ActionScores      = { ATTACK: 0.4, DEFEND:  0.0, EVADE: -0.1, SPECIAL: 0.3, GROUP: 0 };
const HEALTHY_SCORES: ActionScores  = { ATTACK: 0.1, DEFEND:  0.0, EVADE:  0.0, SPECIAL: 0.1, GROUP: 0 };

export const targetVulnerabilityFactor: ScoringFactor = {
  name: 'targetVulnerability',

  evaluate(_self: CombatPerception, target: TargetPerception | null): ActionScores {
    // No target (self-targeting action like EVADE): return neutral
    if (target === null) {
      return { ATTACK: 0, DEFEND: 0, EVADE: 0, SPECIAL: 0, GROUP: 0 };
    }

    const pct = target.staminaPct;

    if (pct < 0.25) {
      return CRITICAL_SCORES;
    } else if (pct <= 0.5) {
      return MID_SCORES;
    } else {
      return HEALTHY_SCORES;
    }
  },
};
